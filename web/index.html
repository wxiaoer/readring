<!DOCTYPE html>
<html>

<head>
    <title>Readring</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <!-- <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"> -->
    <meta name="metro4:init" content="false">
    <link rel="stylesheet" href="dependences/metro4/metro-all.min.css">
    <style>
        html,
        body {
            height: 100%;
        }
    </style>
</head>

<body>
    <div data-role="navview" data-expand="lg" data-compact="fs" data-active-state='true' id="app">
        <iframe v-show='readPageShow' id="readPageIframe" height="100%" width="100%"
            src="/dependences/pdfjs-2.3.200-dist/web/viewer.html" frameborder="0"
            style="position: absolute;z-index: 1000;">iframe</iframe>
        <!-- 侧边菜单 -->
        <div class="navview-pane" style="z-index: 100;">
            <button class="pull-button pos-absolute-right">
                <span class="default-icon-menu"></span>
            </button>
            <div class="suggest-box">
                <input type="text" data-role="input" data-clear-button="false" data-search-button="true">
                <button class="holder">
                    <span class="mif-search"></span>
                </button>
            </div>
            <ul class="navview-menu">
                <li @click="currentPage=0" :class="[currentPage===0?'active':'']">
                    <a class="c-pointer">
                        <span class="icon"><span class="mif-books"></span></span>
                        <span class="caption">Bookshelf</span>
                    </a>
                </li>
                <li @click="currentPage=1" @click.once="initAnalysePage" :class="[currentPage===1?'active':'']">
                    <a class="c-pointer">
                        <span class="icon"><span class="mif-drive"></span></span>
                        <span class="caption">Drive</span>
                    </a>
                </li>
                <li @click="currentPage=1" @click.once="initAnalysePage" :class="[currentPage===2?'active':'']">
                    <a class="c-pointer">
                        <span class="icon"><span class="mif-cog"></span></span>
                        <span class="caption">Setting</span>
                    </a>
                </li>
                <li @click="currentPage=3" :class="[currentPage===3?'active':'']">
                    <a class="c-pointer">
                        <span class="icon"><span class="mif-info"></span></span>
                        <span class="caption">About</span>
                    </a>
                </li>
            </ul>
        </div>

        <!-- body panel -->
        <div class="navview-content h-100 container mt-2">
            <div class="tiles-grid">
                <div @click="openBook(book)" data-role="tile" v-for="book in books">
                    <div class="slide-front">
                        <img src="images/pumba-bg.png" class="h-100 w-100">
                    </div>
                    <span class="branding-bar fg-dark"><span :class="iconMap[book.storageType]"></span>
                        {{book.name}}</span>
                    <span class="badge-top">{{book.page/book.pagesCount}}%</span>
                </div>
                <div @click="addLocalBook()" data-role="tile" class="bg-gray">
                    <span class="icon mif-plus"></span>
                    <span class="branding-bar">Local book</span>
                    <span class="badge-bottom mif-file-pdf"></span>
                </div>
                <div @click="addOnlineBook()" data-role="tile" class="bg-gray">
                    <span class="icon mif-plus"></span>
                    <span class="branding-bar">Online book</span>
                    <span class="badge-bottom mif-cloud"></span>
                </div>
            </div>
            <!-- read page action panel -->
            <div v-show="readPageShow" @click="readPageShow = false" class="pos-fixed pos-bottom-right mr-8 mb-8"
                style="z-index: 1001;opacity: .7;">
                <button class="action-button ">
                    <span class="icon"><span class="mif-backspace"></span></span>
                </button>
            </div>
        </div>
        <input type="file" name="" ref="fileInput" id="" @change='fileInputChange($event)' accept="application/pdf">
    </div>
</body>
<script src="dependences/metro4/metro.min.js"></script>
<script src="dependences/js/vue.js"></script>
<script>
    var app = new Vue({
        el: '#app',
        mounted: function () {
            Metro.init()
        },
        created: function () {
            this.books = JSON.parse(localStorage.getItem('books')) || []
        },
        data: {
            currentPage: 0,
            books: [],
            iconMap: { cloud: 'mif-cloud', local: 'mif-unlink', both: 'mif-done' },
            fileModel: '',
            readPageShow: false,
            currentReadBook: '',
        },
        watch: {
            readPageShow: function (val) {
                if (!val) {
                    this.saveReadProgress()
                }
            }
        },
        methods: {
            openBook: function (book) {
                if (book.name != 'new' && book.name == this.currentReadBook.name) {
                    let pdfApp = document.getElementById("readPageIframe").contentWindow.PDFViewerApplication
                    while (!("fieldData" in pdfApp.pdfDocumentProperties)){
                        pdfApp.pdfDocumentProperties.open()
                        pdfApp.pdfDocumentProperties.close()
                    }
                    if (book.name == pdfApp.baseUrl || book.name == pdfApp.appConfig.documentProperties.fields.fileName.textContent) {
                        this.readPageShow = true
                        return
                    }
                    pdfApp.pdfDocumentProperties.close()
                }
                this.currentReadBook = book
                if (book.storageType == 'cloud') {
                    this.readPageShow = true
                    // Must encodeurlcomponent or can't parse url
                    bookHref = '/dependences/pdfjs-2.3.200-dist/web/viewer.html?file=' + encodeURIComponent(book.remoteUrl) + "#page=" + book.page;
                    document.getElementById("readPageIframe").src = bookHref;
                    document.getElementById("readPageIframe").contentWindow.PDFViewerApplication.pdfDocumentProperties.open()
                } else {
                    this.$refs.fileInput.dispatchEvent(new MouseEvent('click'))
                }
            },
            fileInputChange: function (e) {
                var file = e.target.files[0]
                if (file) {
                    if (file.name == this.currentReadBook.name || this.currentReadBook.name == "new") {
                        this.readPageShow = true
                        var url = URL.createObjectURL(file)
                        if (file.name) {
                            url = {
                                url: url,
                                originalUrl: file.name
                            }
                        }
                        document.getElementById("readPageIframe").contentWindow.PDFViewerApplication.open(url)
                            .then(function () {
                                // 防止缓存导致page未改变
                                setTimeout(() => {
                                    document.getElementById("readPageIframe").contentWindow.PDFViewerApplication.page = app.currentReadBook.page
                                }, 1000);
                            })
                        console.log(document.getElementById("readPageIframe").contentWindow.PDFViewerApplication.page)
                    } else {
                        Metro.toast.create("Please select " + this.currentReadBook.name, null, 3000, 'warning');
                    }
                    this.$refs.fileInput.value = ''
                }
            },
            addLocalBook: function () {
                let book = new Book()
                book.storageType = 'local'
                this.openBook(book)
            },
            addOnlineBook: function () {
                Metro.dialog.create({
                    clsDialog: "light",
                    title: "Online book url",
                    content: '<input id="url" type="text" data-role="input">',
                    onClose: function () {
                        let urlString = $(url).val()
                        let book = new Book()
                        book.storageType = 'cloud'
                        book.remoteUrl = urlString
                        app.openBook(book)
                    }
                });
            },
            saveReadProgress: function () {
                if (this.currentReadBook.name == 'new') {
                    let pdfApp = document.getElementById("readPageIframe").contentWindow.PDFViewerApplication
                    // =为了获取文件名 TODO: 更好的获取文件名方式
                    // pdfApp.pdfDocumentProperties.open()
                    this.currentReadBook.name = this.currentReadBook.storageType == "cloud" ? pdfApp.appConfig.documentProperties.fields.fileName.textContent : pdfApp.baseUrl
                    // pdfApp.pdfDocumentProperties.close()
                    this.currentReadBook.page = pdfApp.page
                    this.currentReadBook.pagesCount = pdfApp.pagesCount
                    this.currentReadBook.lastReadTime = new Date().getTime()
                    this.books.push(this.currentReadBook)
                } else {
                    this.currentReadBook.page = document.getElementById("readPageIframe").contentWindow.PDFViewerApplication.page
                    this.currentReadBook.lastReadTime = new Date().getTime()
                }
            },
        }
    })

    // book 类
    function Book(name, page, pagesCount, storageType, remoteUrl, lastReadTime) {
        this.name = name || 'new'
        this.page = page || 1
        this.pagesCount = pagesCount
        this.storageType = storageType
        this.remoteUrl = remoteUrl
        this.lastReadTime = lastReadTime
    }

    // 页面关闭 保存书架状态
    window.onbeforeunload = function (event) {
        // event.returnValue="sdf"
        app.saveReadProgress()
        if (app.books.length > 0) {
            localStorage.setItem('books', JSON.stringify(app.books))
        }
    }
</script>

</html>