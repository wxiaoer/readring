<!DOCTYPE html>
<html>

<head>
    <title>Readring</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <!-- <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"> -->
    <meta name="metro4:init" content="false">
    <link rel="stylesheet" href="dependences/metro4/metro-all.min.css">
    <style>
        html,
        body {
            height: 100%;
        }
    </style>
</head>

<body>
    <div data-role="navview" data-expand="lg" data-compact="fs" data-active-state='true' id="app">
        <iframe v-show='readPageShow' id="readPageIframe" height="100%" width="100%"
            src="/dependences/pdfjs-2.3.200-dist/web/viewer.html" frameborder="0"
            style="position: absolute;z-index: 1000;">iframe</iframe>
        <!-- 侧边菜单 -->
        <div class="navview-pane" style="z-index: 100;">
            <button class="pull-button pos-absolute-right">
                <span class="default-icon-menu"></span>
            </button>
            <div class="suggest-box">
                <input type="text" data-role="input" data-clear-button="false" data-search-button="true">
                <button class="holder">
                    <span class="mif-search"></span>
                </button>
            </div>
            <ul class="navview-menu">
                <li @click="currentPage=0" :class="[currentPage===0?'active':'']">
                    <a class="c-pointer">
                        <span class="icon"><span class="mif-books"></span></span>
                        <span class="caption">Bookshelf</span>
                    </a>
                </li>
                <li @click="currentPage=1" @click.once="initAnalysePage" :class="[currentPage===1?'active':'']">
                    <a class="c-pointer">
                        <span class="icon"><span class="mif-drive"></span></span>
                        <span class="caption">Drive</span>
                    </a>
                </li>
                <li @click="currentPage=1" @click.once="initAnalysePage" :class="[currentPage===2?'active':'']">
                    <a class="c-pointer">
                        <span class="icon"><span class="mif-cog"></span></span>
                        <span class="caption">Setting</span>
                    </a>
                </li>
                <li @click="currentPage=3" :class="[currentPage===3?'active':'']">
                    <a class="c-pointer">
                        <span class="icon"><span class="mif-info"></span></span>
                        <span class="caption">About</span>
                    </a>
                </li>
            </ul>
        </div>

        <!-- body panel -->
        <div class="navview-content h-100 container mt-2">
            <div class="tiles-grid">
                <div @click="openBook(book)" data-role="tile" v-for="book in books">
                    <div class="slide-front">
                        <img src="images/pumba-bg.png" class="h-100 w-100">
                    </div>
                    <span class="branding-bar fg-dark"><span :class="iconMap[book.storageType]"></span>
                        {{book.name}}</span>
                    <span class="badge-top">{{book.page/book.pagesCount}}%</span>
                </div>
                <div @click="addLocalBook()" data-role="tile" class="bg-gray">
                    <span class="icon mif-plus"></span>
                    <span class="branding-bar">Local book</span>
                    <span class="badge-bottom mif-file-pdf"></span>
                </div>
                <div @click="addOnlineBook()" data-role="tile" class="bg-gray">
                    <span class="icon mif-plus"></span>
                    <span class="branding-bar">Online book</span>
                    <span class="badge-bottom mif-cloud"></span>
                </div>
            </div>
        </div>
        <input type="file" name="" ref="fileInput" id="" @change='fileInputChange($event)' accept="application/pdf">
    </div>
</body>
<script src="dependences/metro4/metro.min.js"></script>
<script src="dependences/js/vue.js"></script>
<script>
    var app = new Vue({
        el: '#app',
        mounted: function () {
            Metro.init()
        },
        created: function () {
            this.books = JSON.parse(localStorage.getItem('books'))
        },
        data: {
            currentPage: 0,
            books: '',
            iconMap: { cloud: 'mif-cloud', local: 'mif-unlink', onSync: 'mif-done' },
            fileModel: '',
            readPageShow: false,
            currentReadBook: '',
        },
        methods: {
            openBook: function (book) {
                this.currentReadBook = book
                if (book.storageType == 'cloud') {
                    this.readPageShow = true
                    // Must encodeurlcomponent or can't parse url
                    bookHref = '/dependences/pdfjs-2.3.200-dist/web/viewer.html?file=' + encodeURIComponent(book.remoteUrl) + "#page=" + book.page;
                    document.getElementById("readPageIframe").src = bookHref;
                } else {
                    this.$refs.fileInput.dispatchEvent(new MouseEvent('click'))
                }
            },
            fileInputChange: function (e) {
                var file = e.target.files[0]
                if (file.name == this.currentReadBook.name || this.currentReadBook.name == "newBook") {
                    this.readPageShow = true
                    var url = URL.createObjectURL(file)
                    if (file.name) {
                        url = {
                            url: url,
                            originalUrl: file.name
                        }
                    }
                    document.getElementById("readPageIframe").contentWindow.PDFViewerApplication.open(url)
                        .then(function () {
                            // 防止缓存导致page未改变
                            setTimeout(() => {
                                document.getElementById("readPageIframe").contentWindow.PDFViewerApplication.page = app.currentReadBook.page
                            }, 1000);
                        })
                    console.log(document.getElementById("readPageIframe").contentWindow.PDFViewerApplication.page)
                } else {
                    Metro.toast.create("Click book named " + this.currentReadBook.name + ", please select book with same name");
                }
            },
            addLocalBook: function () {
                let book = new Book('newBook','','','local','','')
                this.openBook(book)
            },
            addOnlineBook: function () {
                Metro.dialog.create({
                    clsDialog:"light",
                    title: "Online book url",
                    content: '<input id="url" type="text" data-role="input">',
                    onClose:function(){
                        let urlString = $(url).val()
                        let book = new Book('','','','cloud',urlString,'')
                        app.openBook(book)
                    }
                });
            },
        }
    })

    // book 类
    function Book(name, page, pagesCount, storageType, remoteUrl, lastReadTime) {
        this.name = name
        this.page = page || 1
        this.pagesCount = pagesCount
        this.storageType = storageType
        this.remoteUrl = remoteUrl
        this.lastReadTime = lastReadTime
    }
</script>

</html>